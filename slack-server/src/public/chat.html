<meta http-equiv="Content-Security-Policy"
    content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />
    <html>
        <body>
            <link rel="stylesheet" type="text/css" href="styles/style.css" />
        <div class="chatWindow">
            <div class="sidePanel" >
                <div class="nsPanel">
                    <h4 id=""> Workspace </h1>
                    <ul id="nsList"></ul>
                </div>
                <div class="roomPanel">
                    <h4 id=""> Rooms </h1>
                    <ul id="roomsList"></ul>
                </div>
            </div>
            <div class="chatPanel">
                <div class="msgPanel">
                    <h1 id="roomHeader"> Room </h1>
                    <div class="msgWindow">
                        <div id="chatWindowPanel" class="chatWindowPanel">
                            <h1 class='greyText'>No content here :(</h1>
                            <h3 class='greyText'>But you can always initiate a chat....</h3>
                        </div>
                    </div>
                    <div class="chatFormDiv">
                        <form id="chatForm" onsubmit="return false;" >
                            <input type="text" id="chatInput" placeholder="Type Message Here.." value=""/>
                            <button id="sendBtn" onclick="sendMessage()"> Send </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

<script src="/socket.io/socket.io.js"></script>
<script>   
    const mainSocket = io.connect();
    let namespaceList = [];
    let roomList = [];
    let NSSocket;
    let currentNamespace = "";
    let currentRoom = "";
    mainSocket.on('mainSocketMsg' , mainSocketMsg => {
        console.log("Message from mainSocket" , mainSocketMsg)
        if(mainSocketMsg.message.type === 'namespaceList'){
            namespaceList=mainSocketMsg.message.data;
            console.log("namespaceList:" , namespaceList); 
            if(namespaceList.length > 0){
                renderNameSpaces();
                joinNamespace(namespaceList[1].name);
            }    
        }
    });
    const renderNameSpaces = () => {
        const ulElem = document.getElementById('nsList');
        const nsBtns = namespaceList.map((namespace) => {
            console.log(namespace);
            return `
            <div class="nsContent" onclick='joinNamespace("${namespace.name}")'>
            <img src='${namespace.icon}' />
            <button id='${namespace.name}Btn' class='nsBtn'>${namespace.name}</button>
            </div>`;
        });
        ulElem.innerHTML = nsBtns.join('');
    }
    const joinNamespace = ( namespaceName ) => {
        const nsToJoin = namespaceList.filter((ns) => ns.name === namespaceName);
        if( NSSocket ) { console.log("Closing Socket for ", currentNamespace); NSSocket.close(); currentRoom = "";  }
        NSSocket = io.connect(`/${namespaceName}`);
        NSSocket.on(`${namespaceName}NSMsg`, msg => {
            if (currentNamespace !== "") { document.getElementById(`${currentNamespace}Btn`).classList.remove("activeNS"); }
            currentNamespace = namespaceName;
            document.getElementById(`${currentNamespace}Btn`).classList.add("activeNS");
            if(msg.data && msg.data.rooms.length > 0){
                roomList = msg.data.rooms;
                generateRoomUI();
                selectRoom( roomList[0] );
            }
        })
    }

    const generateRoomUI = () => {
        const ulElem = document.getElementById('roomsList');
        const roomBtns = roomList.map((room) => {
            return `<button class='roomBtn' id="${room}Btn" onclick='selectRoom("${room}")'>#${room}</button>`;
        });
        ulElem.innerHTML = roomBtns.join('');
    }

    const selectRoom = ( roomName ) => {
            if (currentRoom !== "") { NSSocket.close();}
            NSSocket = io.connect(`/${currentNamespace}`);
            NSSocket.emit(`${currentNamespace}NSClientMsg`,
            {
                type : 'joinRoom',
                message: "Wanna join the room",
                room : roomName
            }, (roomName , currentNoOfUsers) => {
                if(currentRoom !== ""){document.getElementById(`${currentRoom}Btn`).classList.remove("activeRoom");}
                currentRoom = roomName;
                document.getElementById('roomHeader').innerHTML = `#${roomName}`;
                document.getElementById(`${currentRoom}Btn`).classList.add("activeRoom");
                console.log("Total users: " , currentNoOfUsers);
                
            });
            NSSocket.on(`historyUpdate`, roomHistory => {
                console.log("History Update: ", roomHistory);
                const chatHistory = roomHistory.history;
                if(chatHistory.length > 0 ){
                    let msgHtml = "";
                    chatHistory.forEach(chat => {
                        msgHtml += `<div class="chatContent">${chat}</div>`;
                    });
                    document.getElementById('chatWindowPanel').innerHTML = msgHtml;
                }
                else{
                    document.getElementById('chatWindowPanel').innerHTML = "<h1 class='greyText'>No content here :(</h1> <h3 class='greyText'> But you can always initiate a chat....</h3>";
                }
            });
            NSSocket.on(`RoomMsg`, msg => {
            console.log("Got RoomChatMsg ,", msg, Date.now());
            if (msg.type === 'chatMsg') {
                const msgHtml = `<div class="chatContent">${msg.message}</div>`;
                document.getElementById('chatWindowPanel').innerHTML += msgHtml;

                console.log("Msg from Room Server", msg.message);
            }
            else {
                console.log("Error fetching message from room ", currentRoom);
            }
        });
       
    }

    const sendMessage = () => {
        const message = document.getElementById("chatInput").value;
        console.log("sending message" , message);
        if (NSSocket) {
            NSSocket.emit(`roomChatMsg`,
            {
                type: 'sendRoomMessage',
                message,
                room: currentRoom
            });
        }
    }
</script>